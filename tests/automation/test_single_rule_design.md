# test_single_rule.py 测试设计文档

## 1. 概述

### 1.1 目的
`test_single_rule.py` 是一个单规则快速测试工具，旨在为开发者提供便捷的规则表达式验证环境，无需通过完整的Streamlit界面即可测试和调试交易规则。

### 1.2 核心价值
- **快速验证**: 立即测试规则表达式语法和逻辑正确性
- **调试支持**: 提供详细的调试数据分析
- **开发效率**: 避免反复操作界面的繁琐流程
- **学习工具**: 帮助理解规则解析器的工作机制

## 2. 系统架构

### 2.1 整体架构
```
test_single_rule.py
├── 用户交互层 (CLI界面)
├── 测试数据生成层 (create_test_data)
├── 回测执行层 (BacktestEngine)
├── 结果分析层 (test_rule)
└── 报告展示层 (控制台输出)
```

### 2.2 数据流程
```
用户输入规则 → 生成测试数据 → 创建回测引擎 → 运行回测 → 分析结果 → 展示报告
```

## 3. 功能设计

### 3.1 核心功能模块

#### 3.1.1 测试数据生成 (`create_test_data`)
```python
def create_test_data(days=100):
```

**设计原则**:
- **可重复性**: 使用固定随机种子确保结果一致
- **真实性**: 模拟真实价格走势(趋势+随机波动)
- **可配置性**: 支持自定义数据天数

**数据特征**:
- 时间序列: 2024-01-01开始的连续日期
- OHLCV数据: 开盘价、最高价、最低价、收盘价、成交量
- 价格模式: 0.1%日均涨幅，2%日波动率
- 数据完整性: 确保价格为正，成交量合理

#### 3.1.2 规则测试引擎 (`test_rule`)
```python
def test_rule(buy_rule, sell_rule="", open_rule="", close_rule="", days=100):
```

**参数设计**:
- **灵活配置**: 支持四种规则类型的任意组合
- **可选参数**: 所有规则参数均为可选，适应不同测试场景
- **数据量控制**: 可调整测试数据天数

**测试流程**:
1. 创建测试数据和回测配置
2. 初始化回测引擎和指标服务
3. 注册规则策略
4. 执行回测
5. 分析和展示结果

#### 3.1.3 交互式界面 (`main`)
```python
def main():
```

**用户体验设计**:
- **模式选择**: 提供三种测试模式满足不同需求
- **预定义规则**: 内置常用策略模板
- **自定义输入**: 支持用户自定义规则表达式
- **错误处理**: 友好的错误提示和输入验证

### 3.2 测试模式设计

#### 3.2.1 预定义测试模式
**目标**: 提供常用策略的快速验证

**内置策略**:
1. **基础SMA策略**
   ```python
   buy_rule: SMA(close,5) > SMA(close,20)
   sell_rule: SMA(close,5) < SMA(close,20)
   ```

2. **RSI策略**
   ```python
   buy_rule: RSI(close,14) < 30
   sell_rule: RSI(close,14) > 70
   ```

3. **REF函数策略**
   ```python
   buy_rule: REF(SMA(close,5),1) < SMA(close,5)
   sell_rule: REF(SMA(close,5),1) > SMA(close,5)
   ```

#### 3.2.2 自定义规则模式
**目标**: 支持用户自定义完整策略

**功能特性**:
- 四种规则类型独立配置
- 空规则自动跳过
- 实时语法验证

#### 3.2.3 快速验证模式
**目标**: 单规则快速测试

**适用场景**:
- 规则语法验证
- 逻辑正确性检查
- 指标函数测试

## 4. 数据设计

### 4.1 测试数据结构
```python
{
    'combined_time': datetime,    # 时间戳
    'open': float,               # 开盘价
    'high': float,               # 最高价
    'low': float,                # 最低价
    'close': float,              # 收盘价
    'volume': int,               # 成交量
    'code': str                  # 股票代码
}
```

### 4.2 回测配置设计
```python
BacktestConfig(
    start_date='20240101',
    end_date='20240410',
    target_symbol='test.000001',
    frequency='d',
    initial_capital=100000,
    commission_rate=0.0003,
    strategy_type="自定义规则"
)
```

### 4.3 结果数据结构
```python
{
    'summary': {
        'initial_capital': float,
        'final_capital': float,
        'total_return': float,
        'max_drawdown': float,
        'win_rate': float
    },
    'trades': List[Dict],
    'debug_data': Dict[str, pd.DataFrame]
}
```

## 5. 报告设计

### 5.1 输出格式

#### 5.1.1 基础信息展示
```
🧪 测试规则:
   开仓: [规则表达式]
   清仓: [规则表达式]
   加仓: [规则表达式]
   平仓: [规则表达式]
```

#### 5.1.2 回测结果展示
```
✅ 回测完成
   初始资金: 100,000
   最终资金: 105,230
   总收益率: 5.23%
   最大回撤: -2.15%
   交易次数: 12
   胜率: 66.67%
```

#### 5.1.3 调试数据分析
```
🐛 调试数据分析:
   单规则测试策略:
     - 总列数: 15
     - 指标列: 4 (SMA(close,5), SMA(close,20), RSI(close,14), REF(SMA(close,5),1))
     - 规则列: 2 (SMA(close,5) > SMA(close,20), SMA(close,5) < SMA(close,20))
```

#### 5.1.4 交易记录展示
```
💱 最近5笔交易:
   2024-03-15 - BUY 100股 @ 102.45
   2024-03-18 - SELL 100股 @ 104.23
   ...
```

### 5.2 错误报告设计
```
❌ 测试失败: [详细错误信息]
[错误堆栈信息 - 仅在详细模式下显示]
```

## 6. 性能设计

### 6.1 性能目标
- **响应时间**: 单规则测试 < 5秒
- **内存占用**: < 100MB
- **数据处理**: 支持1000天以上测试数据

### 6.2 优化策略
1. **数据生成优化**: 使用NumPy向量化操作
2. **缓存机制**: 利用规则解析器的内置缓存
3. **内存管理**: 及时释放不需要的数据对象

## 7. 扩展性设计

### 7.1 规则模板扩展
```python
# 预定义规则模板
RULE_TEMPLATES = {
    'MACD策略': {
        'buy_rule': 'MACD(close,12,26,9) > MACD_SIGNAL(close,12,26,9)',
        'sell_rule': 'MACD(close,12,26,9) < MACD_SIGNAL(close,12,26,9)'
    },
    '布林带策略': {
        'buy_rule': 'close < BB_LOWER(close,20,2)',
        'sell_rule': 'close > BB_UPPER(close,20,2)'
    }
}
```

### 7.2 数据模式扩展
- **趋势市场**: 模拟明显的上涨/下跌趋势
- **震荡市场**: 模拟横盘整理
- **极端行情**: 模拟暴涨暴跌场景
- **跳空场景**: 模拟缺口行情

### 7.3 输出格式扩展
- **JSON格式**: 便于程序化处理
- **CSV导出**: 支持数据分析
- **图表展示**: 可视化测试结果

## 8. 测试用例设计

### 8.1 功能测试用例

#### 8.1.1 基础功能测试
- **TC001**: 预定义规则测试
- **TC002**: 自定义规则输入测试
- **TC003**: 单规则快速验证测试

#### 8.1.2 规则语法测试
- **TC004**: 有效规则表达式测试
- **TC005**: 无效规则表达式测试
- **TC006**: 复杂嵌套规则测试

#### 8.1.3 指标函数测试
- **TC007**: SMA指标测试
- **TC008**: RSI指标测试
- **TC009**: REF函数测试
- **TC010**: 组合指标测试

### 8.2 异常处理测试
- **TC011**: 空规则输入测试
- **TC012**: 语法错误处理测试
- **TC013**: 数据异常处理测试

### 8.3 性能测试
- **TC014**: 大数据量测试(1000+天)
- **TC015**: 复杂规则性能测试
- **TC016**: 内存占用测试

## 9. 使用场景

### 9.1 开发阶段
- **规则调试**: 验证新编写的规则表达式
- **逻辑验证**: 确认交易逻辑的正确性
- **性能评估**: 初步评估策略表现

### 9.2 学习阶段
- **语法学习**: 理解规则表达式语法
- **指标学习**: 了解各种技术指标的使用
- **策略学习**: 学习经典策略的实现

### 9.3 验证阶段
- **回归测试**: 验证修改后的规则是否仍然有效
- **对比测试**: 比较不同规则的表现
- **边界测试**: 测试极端情况下的规则行为

## 10. 最佳实践

### 10.1 规则编写建议
1. **渐进式开发**: 从简单规则开始，逐步增加复杂度
2. **充分测试**: 使用多种市场条件验证规则
3. **性能考虑**: 避免过度复杂的嵌套规则

### 10.2 测试建议
1. **多场景测试**: 使用不同的测试数据
2. **参数调优**: 测试不同参数组合
3. **结果验证**: 检查调试数据是否符合预期

### 10.3 调试技巧
1. **分步验证**: 分别测试各子规则
2. **数据分析**: 仔细检查调试数据的列
3. **日志分析**: 关注控制台输出的详细信息

## 11. 未来改进方向

### 11.1 功能增强
- **可视化支持**: 集成matplotlib/plotly图表
- **批量测试**: 支持多个规则同时测试
- **参数优化**: 集成参数寻优功能

### 11.2 用户体验
- **历史记录**: 保存测试历史
- **规则库**: 建立规则模板库
- **智能提示**: 提供规则编写提示

### 11.3 集成能力
- **CI/CD集成**: 支持自动化测试流程
- **报告系统**: 集成正式的测试报告系统
- **数据源集成**: 支持真实市场数据测试

---

*文档版本: v1.0*
*最后更新: 2025-01-31*