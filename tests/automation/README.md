# 自动化测试说明

## 概述

本目录包含自动化回测测试套件，用于验证规则解析器和回测引擎的功能，无需手动操作界面。

## 文件说明

### 核心文件
- `test_backtest_automation.py` - 主要的自动化测试套件
- `run_automation_tests.py` - 快速运行脚本（项目根目录）
- `test_single_rule.py` - 单规则快速测试工具（项目根目录）

## 使用方法

### 1. 统一测试入口 (推荐)

运行测试选择器，根据需要选择测试类型：

```bash
python run_automation_tests.py
```

选项说明：
- **选项1**: 独立规则测试 (推荐，无Streamlit依赖)
- **选项2**: 完整回测测试 (需要Streamlit环境)
- **选项3**: 单规则测试 (需要Streamlit环境)

### 2. 独立规则测试 (推荐用于快速验证)

直接运行无Streamlit依赖的规则测试：

```bash
python test_rule_standalone.py
```

**优势**:
- 无需Streamlit环境
- 直接测试规则解析器
- 快速验证规则语法和逻辑
- 详细的调试数据分析

**功能**:
- 预定义规则测试 (4种经典策略)
- 自定义规则输入测试
- 单规则快速验证
- 信号生成分析
- 调试数据列分析

### 3. 完整回测测试 (需要Streamlit环境)

运行完整的回测流程测试：

```bash
python tests/automation/test_backtest_automation.py
```

**测试内容**:
- 基础SMA策略
- RSI超买超卖策略
- 多重条件策略
- REF函数策略
- 复杂嵌套策略

**特性**:
- 完整的回测流程验证
- 交易记录生成
- 性能指标计算
- JSON格式测试报告

### 4. 单规则测试 (需要Streamlit环境)

通过Streamlit环境测试单个规则：

```bash
python test_single_rule.py
```

**功能**:
- 预定义规则测试
- 自定义规则输入
- 回测结果展示
- 交易记录查看

### 5. 测试报告

不同测试类型的报告输出：

**独立规则测试**:
- 控制台实时输出：信号统计、调试数据分析
- 数据示例展示：最后5行数据预览

**完整回测测试**:
- 控制台汇总信息：通过率、失败详情
- JSON报告文件：`test_report_YYYYMMDD_HHMMSS.json`

**单规则测试**:
- 详细的回测结果展示
- 交易记录和性能指标

## 测试特性

### 验证项目
1. **回测流程** - 完整的回测执行流程
2. **规则解析** - 各种规则表达式的正确性
3. **指标计算** - SMA、RSI等技术指标
4. **调试数据** - 规则解析器生成的调试数据
5. **信号生成** - 交易信号的生成逻辑

### 调试数据分析
- 数据列数量统计
- 指标列识别（SMA、RSI、MACD、REF等）
- 规则表达式结果列识别
- 调试数据完整性验证

### 错误处理
- 规则语法错误捕获
- 运行时异常处理
- 详细的错误信息输出

## 自定义测试

### 添加新测试用例

在 `test_backtest_automation.py` 中的 `run_test_suite` 方法中添加新的测试用例：

```python
{
    'name': '你的测试名称',
    'config': self.create_test_config("自定义规则", {
        'buy_rule': '你的买入规则',
        'sell_rule': '你的卖出规则'
    })
}
```

### 自定义测试数据

修改 `_create_test_data` 方法来生成特定的测试数据：
- 调整数据天数
- 修改价格走势模式
- 添加特定的市场条件

## 故障排除

### 常见问题

1. **Streamlit依赖错误**
   ```
   st.session_state has no attribute "db"
   ```
   **解决方案**: 使用独立规则测试 (`test_rule_standalone.py`)

2. **导入错误**
   - 确保在项目根目录运行脚本
   - 检查Python路径设置
   - 使用选项1的独立测试避免依赖问题

3. **规则语法错误**
   - 使用 `test_rule_standalone.py` 快速验证规则语法
   - 检查指标函数名称和参数格式

4. **数据问题**
   - 测试使用模拟数据，与真实市场数据可能有差异
   - 可以修改脚本中的随机种子来改变测试数据

### 推荐测试流程

1. **快速验证**: 使用独立规则测试验证语法和逻辑
2. **详细分析**: 如需完整回测，使用完整测试套件
3. **问题调试**: 查看控制台输出的详细错误信息

### 调试技巧

1. **使用独立测试**
   ```bash
   python test_rule_standalone.py
   ```
   - 无依赖问题
   - 详细的调试数据分析

2. **分析调试数据**
   - 查看生成的指标列数量和名称
   - 验证规则结果列是否正确生成
   - 检查信号生成时间和频率

3. **分步验证**
   - 先测试简单规则
   - 逐步增加复杂度
   - 对比不同参数的结果

## 扩展功能

可以考虑添加的功能：
- 真实市场数据测试
- 性能基准测试
- 批量规则验证
- 可视化测试结果
- 回归测试套件