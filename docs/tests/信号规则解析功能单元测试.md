# 信号规则解析功能单元测试

## 测试文件信息

- **文件路径**: `tests/core/strategy/test_rule_parser.py`
- **测试模块**: `src.core.strategy.rule_parser`
- **测试类**: `RuleParser`
- **测试框架**: `pytest`

## 测试概述

本测试文件用于验证信号规则解析器的核心功能，包括规则解析、指标计算、边界条件处理等。

## 测试用例详情

### 1. `test_ref_function` - REF函数测试

**测试目的**: 验证REF函数正确回溯历史值

**测试输入**:
- 规则表达式: `"REF(SMA(close,5),1) < SMA(close,5)"`
- 测试数据: 包含10个递增收盘价的DataFrame
- 测试位置: 从索引1到9

**预期输出**:
- 所有位置都应返回 `True`
- REF(SMA(5),1) 应小于当前SMA(5)

**测试逻辑**:
- 验证REF函数能够正确获取历史指标值
- 确保REF函数在不同位置都能正常工作

### 2. `test_nested_functions` - 嵌套函数测试

**测试目的**: 验证嵌套函数调用功能

**测试输入**:
- 规则表达式: `"REF(REF(SMA(close,5),1),1) < SMA(close,5)"`
- 测试数据: 包含10个递增收盘价的DataFrame
- 测试位置: 索引5

**预期输出**:
- 返回 `True`
- 嵌套REF应小于当前SMA(5)

**测试逻辑**:
- 验证多层嵌套函数调用的正确性
- 确保复杂表达式能够正确解析

### 3. `test_boundary_conditions` - 边界条件测试

**测试目的**: 验证边界条件处理

**测试输入**:
- 边界测试: `"REF(SMA(close,2),3) > 0"` (索引越界)
- 空值测试: `"close > 0"` (包含NaN值的数据)
- 测试数据:
  - 边界测试: 3个收盘价数据
  - 空值测试: 包含NaN值的3个数据点

**预期输出**:
- 边界测试: 返回 `False` (REF返回0)
- 空值测试:
  - 索引0: `True` (正常值)
  - 索引1: `False` (NaN值)

**测试逻辑**:
- 验证索引越界时的正确处理
- 验证NaN值的正确处理

### 4. `test_recursion_limit` - 递归深度限制测试

**测试目的**: 验证递归深度限制

**测试输入**:
- 深度嵌套表达式: 10层REF嵌套
- 规则表达式: `"REF(REF(...REF(SMA(close,2),1)...),1) > 0"`
- 测试位置: 索引5

**预期输出**:
- 抛出 `RecursionError` 异常

**测试逻辑**:
- 验证系统对过度递归的保护机制
- 确保不会因无限递归导致系统崩溃

### 5. `test_evaluate_at` - 位置评估测试

**测试目的**: 验证evaluate_at方法在不同位置的结果

**测试输入**:
- 规则表达式: `"SMA(close,5) > SMA(close,2)"`
- 测试数据: 包含10个递增收盘价的DataFrame
- 测试位置: 索引4,7,9

**预期输出**:
- 位置4,7,9: 返回 `False`
- 验证表达式: `"SMA(close,2) > SMA(close,5)"` 在位置4返回 `True`

**测试逻辑**:
- 验证不同位置评估结果的正确性
- 确保指标计算的时间窗口正确

### 6. `test_cache_mechanism` - 缓存机制测试

**测试目的**: 验证缓存机制的性能提升

**测试输入**:
- 规则表达式: `"SMA(close,5) > SMA(close,20)"`
- 测试位置: 索引5
- 测试方式: 同一位置重复评估

**预期输出**:
- 第二次评估时间应显著小于第一次
- 性能提升至少50%

**测试逻辑**:
- 验证缓存机制的有效性
- 确保重复计算能够利用缓存

### 7. `test_complex_logic` - 复杂逻辑表达式测试

**测试目的**: 验证复杂逻辑表达式的解析

**测试输入**:
- 规则表达式: `"(SMA(close,5) > 30) & (RSI(14) < 70) | (VOLUME > 100)"`
- 测试位置: 索引7

**预期输出**:
- 返回 `True`

**测试逻辑**:
- 验证AND/OR逻辑组合的正确解析
- 确保复杂表达式能够正确评估

### 8. `test_multi_indicator` - 多指标组合测试

**测试目的**: 验证多指标组合功能

**测试输入**:
- 规则表达式: `"SMA(close,5) > SMA(close,10) & RSI(14) < 70"`
- 测试位置: 索引8

**预期输出**:
- 返回 `True`

**测试逻辑**:
- 验证多指标组合表达式的正确性
- 确保不同指标能够协同工作

### 9. `test_extreme_params` - 极端参数测试

**测试目的**: 验证极端参数值的处理

**测试输入**:
- 长序列测试: 1000个相同收盘价
- 极小周期: `"SMA(close,1) == 10"`
- 极大周期: `"SMA(close,200) == 10"`
- 边界REF: `"REF(SMA(close,5),995) > 0"`

**预期输出**:
- 极小周期: 返回 `True`
- 极大周期: 返回 `True`
- 边界REF: 返回 `False`

**测试逻辑**:
- 验证极端参数值的鲁棒性
- 确保边界条件的正确处理

### 10. `test_performance` - 性能基准测试

**测试目的**: 验证性能基准

**测试输入**:
- 测试数据: 10000个相同收盘价
- 规则表达式: `"REF(SMA(close,5),1) > REF(SMA(close,20),1) & SMA(close,5) > SMA(close,20)"`
- 测试范围: 索引100到1100

**预期输出**:
- 1000次评估耗时小于2秒

**测试逻辑**:
- 验证系统在大数据量下的性能
- 确保复杂规则评估的效率

## 测试数据说明

### 标准测试数据
```python
df = pd.DataFrame({
    'close': [10.0, 20.0, 30.0, 40.0, 50.0, 60.0, 70.0, 80.0, 90.0, 100.0],
    'volume': [100, 200, 300, 400, 500, 600, 700, 800, 900, 1000]
})
```

### 模拟指标服务
- 所有指标计算返回固定值 `10.0`
- 用于隔离测试规则解析逻辑

## 测试环境要求

- Python 3.7+
- pandas
- numpy
- pytest
- 项目根目录正确设置Python路径

## 运行方式

```bash
# 运行单个测试
python Scripts/tests/run_all_tests.py tests/core/strategy/test_rule_parser.py

# 运行所有测试
python Scripts/tests/run_all_tests.py

# 快速测试
python Scripts/tests/quick_test.py
```

## 测试覆盖率

本测试覆盖了规则解析器的以下核心功能：

- ✅ 基础函数调用 (REF, SMA, RSI等)
- ✅ 嵌套函数调用
- ✅ 边界条件处理
- ✅ 递归深度限制
- ✅ 位置评估
- ✅ 缓存机制
- ✅ 复杂逻辑表达式
- ✅ 多指标组合
- ✅ 极端参数处理
- ✅ 性能基准

## 注意事项

1. 测试使用模拟指标服务，不依赖真实数据源
2. 性能测试可能受运行环境影响
3. 边界条件测试确保系统的鲁棒性
4. 所有测试都应在隔离环境中运行