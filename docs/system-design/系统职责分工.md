# 命名一致性
- 管理类：Manager后缀（RiskManager）
- 策略相关：Strategy后缀（PositionStrategy）
- 数据源：Source后缀（DataSource）
- 事件：无后缀（OrderEvent）



# src/core/data/database.py
## DatabaseManager
- 负责数据库连接池管理（asyncpg实现）
- 表结构初始化
- 股票数据CRUD操作
- 数据完整性检查

主要方法
- save_order：保存订单
- update_order_status：更新订单状态
- log_execution：交易执行结果日志记录
- record_trade：交易记录
- query_orders：订单队列
- query_trades：交易历史队列

待实现：
- 添加交易相关方法
```
async def save_order(self, order: dict) -> int:
        """异步保存订单"""
        async with self.pool.acquire() as conn:
            return await conn.fetchval("""
                INSERT INTO Orders (...) VALUES (...) RETURNING order_id
            """, ...)
```


- 

# src/core/data/data_source.py
## DataSourceError
- 数据源操作异常基类
## DataSource
- 数据源抽象基类

# src/core/data/data_factory.py
## DataFactory(DataSource)
- 数据源工厂类，实现单例模式和线程安全的数据源管理
### BaostockDataSource(DataSource)
- 已注册到数据源工厂
### AkShareSource(DataSource)
- 已注册到数据源工厂

# src/core/data/market_data_source.py
## DatabaseConnection(Protocal)
- 可能冗余
- 数据库连接协议
## MarketDataSource(DataSource)
市场数据源实现类


# src/core/execution/Trader.py
## TradeOrderManager(BaseTrader)
- 负责订单生命周期管理（创建、修改、取消、状态管理、数据库操作）
- process_orders：处理等待中的订单，使用注入的trader执行订单

## TradeExecutionEngine
- 负责交易指令生成
## TradeRecorder

## BaseTrader
## BacktestTrader(BaseTrader)
- 负责订单实际执行和事件转换
- execute_order：回测时处理OrderEvent并返回FillEvent
## LiveTrader(BaseTrader)
- 负责实际执行和事件转换


# src/core/risk/risk_manager.py
## RiskManager
- 负责系统级风险控制（全局资金/仓位限额）
- 负责验证PositionStrategy的输出是否合规（风控）

待分析
输入​：所有策略的目标仓位、系统风险参数（总资金限额、集中度阈值）、实时账户状态。
•
​输出​：风险验证结果（通过/拒绝/调整建议）。
- 验证策略输出是否违反系统级风控规则（如总仓位≤总资金的50%）
- 动态调整仓位以符合全局约束（如自动缩减超限订单的数量）
- 举例：你有n个策略，提供了n个仓位目标， RiskManager会校验总和是否超出资金上限、单一标的持仓 ≤ 总资金的10%等

属性
- portfolio：PortfolioManager




主要方法
- validate_order：验证订单风险是否通过
- _check_funds：检查资金是否充足
- _check_position：检查是否超过仓位限制

问题：
- RiskManager直接访问`portfolio.get_position()`和`portfolio.get_strategy_limit()`
- 这可能导致RiskManager与Portfolio实现强耦合


# src/core/strategy/strategy.py
## BaseStrategy
## FixedInvestmentStrategy

# src/core/strategy/rule_parser.py
## IndicatorFunction
## RuleParser


# src/core/strategy/rule_based_strategy.py
## RuleBasedStrategy

# src/core/strategy/position_strategy.py
## PositionStrategy
仓位策略基类
- 基于策略逻辑生成目标仓位
- 

待分析：
输入​：市场数据（价格、波动率）、策略参数（风险偏好、杠杆率）、账户状态（当前持仓）。
•
​输出​：策略级别的目标仓位（如股票A买入200股）
- 计算信号强度
- 应用策略级风控

## FixedPercentStrategy(PositionStrategy)
固定比例仓位策略
- calculate_position：计算仓位比例
## KellyStrategy(PositionStrategy)
凯利公式仓位策略
- calculate_position：计算凯利公式仓位

# src/core/strategy/indicators.py
## IndicatorService

# src/core/strategy/dca_strategy.py
## DCABaseStrategy


# src/core/strategy/backtesting.py
## BacktestConfig
- 负责管理回测所需的所有参数配置
属性
- initial_capital (float): 初始资金，默认100万
- commission_rate (float): 单笔交易手续费率（百分比值），默认0.0005，表示0.0005%手续费率
- slippage (float): 滑点率，默认0.001
- start_date (str): 回测开始日期，格式'YYYY-MM-DD'
- end_date (str): 回测结束日期，格式'YYYY-MM-DD'
- target_symbol (str): 目标交易标的代码
- monthly_investment (Optional[float]): 每月定投金额，None表示不定投
- stop_loss (Optional[float]): 止损比例，None表示不启用
- take_profit (Optional[float]): 止盈比例，None表示不启用
- max_holding_days (Optional[int]): 最大持仓天数，None表示不限制
- extra_params (Dict[str, Any]): 额外参数存储



## BacktestEngine
- 负责执行回测流程


方法
get_results:获取回测结果
- _handle_fill_event：订单完成后，处理事件：更新仓位等信息


属性
- portfolio: BacktestPortfolioAdapter类
  - `available_cash`: 返回当前可用现金  
  - `total_value`: 计算总资产价值（现金 + 持仓市值）  
  - `get_position()`: 获取当前持仓数量  
  - `get_strategy_limit()`: 获取策略的最大持仓比例（默认20%）[7](@ref)

主要方法
_validate_order_risk：使用RiskManager.validate_order进行完整的风险检查

# src/core/portfolio/portfolio.py
## PortfolioManager

- __投资组合管理__：管理整个投资组合的资产配置和持仓情况

- __资金管理__：跟踪和管理可用现金、初始资金和组合总价值

- __持仓操作__：执行买入、卖出等持仓更新操作历史记录

- __组合再平衡__：根据目标配置比例自动调整持仓

- __风险控制集成__：与风险管理系统集成进行风险检查
- 收益指标


方法
- update_position：更新持仓
- get_portfolio_value：获取投资组合总价值 （不使用@st.cache_data）
- rebalance：组合再平衡
## Position
stock
quantity
avg_cost
current_value

## PositionStrategyFactory

# src/event_bus/handlers/strategy/strategy_handler.py
## StrategyEventHandler
- 策略事件处理

# src/event_bus/event_types.py
## BaseEvent
事件基类
## MarketDataEvent
行情数据事件
## OrderEvent
订单事件


## FillEvent
成交回报事件
## SignalEvent
信号事件
## SystemEvent
系统控制事件
## StrategySignalEvent
策略信号事件


## StrategyScheduleEvent
策略定时任务事件
## TradingDayEvent
交易日事件
## PortfolioPositionUpdateEvent
投资组合持仓更新事件