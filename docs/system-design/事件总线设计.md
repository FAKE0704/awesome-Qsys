# 事件总线系统设计文档

## 架构概述
事件总线系统为量化交易平台提供统一的事件驱动架构，支持实时行情处理和多策略并发执行。系统包含两种实现：
1. **RedisStreamBus**：基于Redis Streams的生产环境实现，保证事件顺序性和高吞吐量
2. **LocalSimBus**：基于内存的模拟总线，专为回测场景设计，支持时间加速控制

## 核心类说明

### EventBus 抽象基类
```python
class EventBus(ABC):
    """事件总线抽象基类"""
    @abstractmethod
    def publish(self, event_type: str, event: object):
        """发布事件到指定频道"""

    @abstractmethod
    def subscribe(self, event_type: str, handler: Callable[[Any], Any]):
        """订阅指定频道的事件"""
```
- **职责**：定义事件总线统一接口
- **位置**：`src/event_bus/__init__.py`

### RedisStreamBus
```python
class RedisStreamBus(EventBus):
    """基于Redis Stream的有序事件总线"""
    def __init__(self, host='localhost', port=6379, consumer_group='default'):
        # 初始化Redis连接
    
    def publish(self, event_type: str, event: Any):
        # 发布事件到Redis Stream
    
    def subscribe(self, event_type: str, handler: Callable[[Any], None]):
        # 订阅事件并启动处理线程
```
- **特性**：
  - 使用Redis Streams保证事件顺序
  - 支持消费者组隔离
  - 自动消息确认机制
- **位置**：`src/event_bus/redis_stream_bus.py`

### LocalSimBus
```python
class LocalSimBus(EventBus):
    """基于内存的模拟事件总线（用于回测）"""
    def __init__(self, time_scale: float = 1.0):
        # 初始化模拟环境
    
    def publish(self, event_type: str, event: Any, delay: float = 0.0):
        # 发布带延迟的事件
    
    def subscribe(self, event_type: str, handler: Callable[[Any], None]):
        # 订阅事件
    
    def advance_time(self, delta: float):
        # 推进模拟时间
```
- **特性**：
  - 完全内存操作，零外部依赖
  - 支持时间加速/减速控制
  - 精确事件时序模拟
- **位置**：`src/event_bus/local_sim_bus.py`

## 使用示例

### 生产环境使用（RedisStreamBus）
```python
from src.event_bus.redis_stream_bus import RedisStreamBus

# 初始化总线
bus = RedisStreamBus(host='redis-server', port=6379)

# 定义事件处理器
def handle_market_data(event):
    print(f"收到行情事件: {event}")

# 订阅行情事件
bus.subscribe("MARKET_DATA", handle_market_data)

# 发布事件
bus.publish("MARKET_DATA", {"symbol": "SH600000", "price": 42.3})
```

### 回测环境使用（LocalSimBus）
```python
from src.event_bus.local_sim_bus import LocalSimBus

# 初始化模拟总线（10倍加速）
bus = LocalSimBus(time_scale=10.0)

# 定义事件处理器
def backtest_handler(event):
    print(f"[T+{event['time']}] 处理事件: {event}")

# 订阅事件
bus.subscribe("BACKTEST_EVENT", backtest_handler)

# 发布带延迟的事件
bus.publish("BACKTEST_EVENT", {"time": 0, "data": "开盘"}, delay=0)
bus.publish("BACKTEST_EVENT", {"time": 3600, "data": "收盘"}, delay=3600)

# 推进时间（实际耗时360秒）
bus.advance_time(3600)
```

## 注意事项
1. **事件顺序保证**：
   - RedisStreamBus使用Redis Streams保证严格时序
   - LocalSimBus通过内部队列保证FIFO顺序

2. **性能考量**：
   - RedisStreamBus建议部署专用Redis集群
   - LocalSimBus在回测中避免高频事件（>10K/秒）

3. **错误处理**：
   - Redis连接失败会抛出RuntimeError
   - 事件处理器异常需自行捕获

4. **扩展建议**：
   - 新增事件类型需统一前缀（如`MD_`、`TRADE_`）
   - 复杂事件可使用Protocol Buffers序列化
```

> 完整类图参考：[事件总线类图.md](./事件总线类图.md)
